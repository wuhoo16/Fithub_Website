{% extends 'base.html' %}

{% block head %}
    <title>Youtube Channel Model Page</title>
    <script type="text/javascript" src="/static/channels_filter_verification.js"></script>
{% endblock %}


{% block body %}
<div class="exercise-div container-fluid">   
    <div class="jumbotron-exercise jumbotron jumbotron-fluid text-center">
        <h1 class="modelHeader">Get ready to get fit</h1>
        <p class="modelDescription">Explore some of the most popular Youtube fitness channels.</p>
    </div> 
    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <form id="channelsFilterForm" action="{{ url_for('channels', page_number=1) }}" method="post">
            <ul class="checkbox-menu">
                <li class="dropdown-header">Subscribers</li>
                <li>
                    <label><input type="checkbox" id='channelsOption1' name='checkedSubscriberRange' value="0 1000"> 0 - 1K </label>
                </li>
                <li>
                    <label><input type="checkbox" id='channelsOption2' name='checkedSubscriberRange' value="1000 100000"> 1K- 100K </label>
                </li>
                <li>
                    <label><input type="checkbox" id='channelsOption3' name='checkedSubscriberRange' value="100000 1000000"> 100K - 1M</label>
                </li>
                <li>
                    <label><input type="checkbox" id='channelsOption4' name='checkedSubscriberRange' value="1000000 10000000"> 1M - 10M</label>
                </li>
                <li>
                    <label><input type="checkbox" id='channelsOption5' name='checkedSubscriberRange' value="10000000 999000000"> 10M+</label>
                </li>
                <li class="dropdown-header">Total Views</li>
                <li>
                    <label> <input type="checkbox" id='channelsOption6' name='checkedTotalViewsRange' value="0 100000"> 0 - 100K </label>
                </li>
                <li>
                    <label><input type="checkbox" id='channelsOption7' name='checkedTotalViewsRange' value="100000 1000000"> 100K - 1M </label>
                </li>
                <li>
                    <label><input type="checkbox" id='channelsOption8' name='checkedTotalViewsRange' value="1000000 5000000"> 1M - 5M </label>
                </li>
                <li>
                    <label><input type="checkbox" id='channelsOption9' name='checkedTotalViewsRange' value="5000000 25000000"> 5M - 25M </label>
                </li>
                <li>
                    <label><input type="checkbox" id='channelsOption10' name='checkedTotalViewsRange' value="25000000 50000000"> 25M - 50M </label>
                </li>
                <li>
                    <label><input type="checkbox" id='channelsOption11' name='checkedTotalViewsRange' value="50000000 999000000000"> 50M+ </label>
                </li>
                <li class="dropdown-header">Videos</li>
                <li>
                    <label> <input type="checkbox" id='channelsOption12' name='checkedVideosRange' value="0 100"> 0 - 100</label>
                </li>
                <li>
                    <label> <input type="checkbox" id='channelsOption13' name='checkedVideosRange' value="100 250"> 100 - 250</label>
                </li>
                <li>
                    <label> <input type="checkbox" id='channelsOption14' name='checkedVideosRange' value="250 500"> 250 - 500</label>
                </li>
                <li>
                    <label> <input type="checkbox" id='channelsOption15' name='checkedVideosRange' value="500 1000"> 500 - 1K</label>
                </li>
                <li>
                    <label> <input type="checkbox" id='channelsOption16' name='checkedVideosRange' value="1000 9999"> 1K+ </label>
                </li>
                <li style="text-align: center; margin-top: 1rem;  margin-bottom: 110px;">
                    <input type="hidden" id='channelsResetHiddenField' name='resetHiddenField' value="">
                    <button class="reset-button btn btn-outline-light" type="button" name="Reset" onclick="resetCheckboxState('channelsFilterForm', 'channelsResetHiddenField')">Reset</button>
                    <button class="filter-button btn btn-outline-light" type="button" name="Filter" onclick="verifyCheckBoxes('channelsFilterForm')">Filter</button>
                </li>  
            </ul>
        </form>    
    </div>

    <!-- Use any element to open the sidenav -->
    <div>
        <button class="filter-open-button" onclick="openNav()">Filter ></button>
        <a href="#"><img class="ascending-button" src="/static/arrow.png" alt="Ascending" onclick="sortAscending();"></a>
        <a href="#"><img class="descending-button" src="/static/arrow.png" alt="Descending" onclick="sortDescending();"></a>
    </div>

    <!-- Add all page content inside this div if you want the side nav to push page content to the right (not used if you only want the sidenav to sit on top of the page -->
    <div id="main">
        {% set dataArr = [] %}
        {% for i in range(channelArrayLength) %}
            {% if channelArray[i].description|length == 0 %}
                {% set dataArr = dataArr.append({"name": channelArray[i].name, "description": "|No description provided.", "subscriber": channelArray[i].subscriberCount, "view": channelArray[i].viewCount, "video": channelArray[i].videoCount}) %}
            {% else %}
            {% set dataArr = dataArr.append({"name": channelArray[i].name, "description": channelArray[i].description, "subscriber": channelArray[i].subscriberCount, "view": channelArray[i].viewCount, "video": channelArray[i].videoCount}) %}
            {% endif %}
        {% endfor %}
        <meta id="channelArrayData" data-arr='{{dataArr}}'/>
        <div class="dropdown">
            <input class="form-control ml-3 w-75 dropdown-toggle" id = "searchBar" type="text" placeholder="Search"/>
            <div id="menu" class="dropdown-menu" aria-labelledby="dropdown_coins">
                <div id="menuItems"></div>
                <div id="empty" class="dropdown-header">No items found</div>
            </div>
        </div>
        <div class="grid-div container-fluid" id="modelGrid">
        {% set numFullRows = ((end + 1) - start) // 3 %}
        {% set numLeftOverChannels = ((end + 1) - start) % 3 %}
        {% for i in range(numFullRows) %}
            <div class="row justify-content-center" id="row{{ i|string }}">
                {% for offset in range(3) %}
                <div class="col-md-4 p-4">
                    <div class="card card-style h-100 pt-4">
                        <img class="card-img-top card-image-style img-fluid mx-auto" src="{{ channelArray[start + 3*i + offset].thumbnailURL }}" alt="{{ channelArray[start + 3*i + offset].name }}">
                        <div class="card-body">
                            <h2 class="card-title text-center">{{ channelArray[start + 3*i + offset].name }}</h2>
                            <p class="card-text">
                                <ul class="channelAttributesList list-unstyled" id="list_{{channelArray[start + 3*i + offset].arrayIndex}}">
                                    {% if channelArray[start + 3*i + offset].description|length != 0 %}
                                        <li style="padding-bottom: 0.5em; padding-left: 1em; padding-top: 1em;" id="descriptionTxt_{{channelArray[start + 3*i + offset].arrayIndex}}"><b>Description: </b>{{ channelArray[start + 3*i + offset].description }}</li>
                                    {% else %}
                                        <li style="padding-bottom: 0.5em; padding-left: 1em; padding-top: 1em;" id="descriptionTxt_{{channelArray[start + 3*i + offset].arrayIndex}}"><b>Description: </b>No description provided.</li>
                                    {% endif %}
                                    <li style="padding-bottom: 0.5em; padding-left: 1em;" id="subscriberTxt_{{channelArray[start + 3*i + offset].arrayIndex}}"><b>Subscribers: </b>{{ channelArray[start + 3*i + offset].subscriberCount }}</li>
                                    <li style="padding-bottom: 0.5em; padding-left: 1em;" id="viewTxt_{{channelArray[start + 3*i + offset].arrayIndex}}"><b>Total Views: </b>{{ channelArray[start + 3*i + offset].viewCount }}</li>
                                    <li style="padding-left: 1em;" id="videoTxt_{{channelArray[start + 3*i + offset].arrayIndex}}"><b>Videos: </b>{{ channelArray[start + 3*i + offset].videoCount }}</li>
                                </ul>
                            </p>
                            <a href="{{ url_for('channel_instance', arrayIndex=channelArray[start + 3*i + offset].arrayIndex) }}" class="stretched-link"></a>
                        </div>
                    </div>
                </div>
                {% endfor %}      
            </div>
        {% endfor %}

        <!-- Now if there are leftover channels, we place the leftover channels into bottom-most row, using indexing from back of the array -->
        {% if numLeftOverChannels > 0 %}
            <div class="row" id="bottomRow">
            {% for i in range(-numLeftOverChannels, 0) %}
                <div class="col-md-4 p-4">
                    <div class="card card-style h-100 pt-4">
                        <img class="card-img-top card-image-style img-fluid mx-auto" src="{{ channelArray[end + 1 + i].thumbnailURL }}" alt="{{ channelArray[end + 1 + i].name }}">
                        <div class="card-body">
                            <h2 class="card-title text-center">{{ channelArray[end + 1 + i].name }}</h2>
                            <p class="card-text">
                                <ul class="channelAttributesList list-unstyled">
                                    <li style="padding-bottom: 0.5em; padding-left: 1em; padding-top: 1em;"><b>Description: </b>{{ channelArray[end + 1 + i].description }}</li>
                                    <li style="padding-bottom: 0.5em; padding-left: 1em;"><b>Subscribers: </b>{{ channelArray[end + 1 + i].subscriberCount }}</li>
                                    <li style="padding-bottom: 0.5em; padding-left: 1em;"><b>Total Views: </b>{{ channelArray[end + 1 + i].viewCount }}</li>
                                    <li style="padding-left: 1em;"><b>Videos: </b>{{ channelArray[end + 1 + i].videoCount }}</li>
                                </ul>
                            </p>
                            <a href="{{ url_for('channel_instance', arrayIndex=channelArray[end + 1 + i].arrayIndex) }}" class="stretched-link"></a>
                        </div>
                    </div>
                </div>
            {% endfor %}
            </div>
        {% endif %}
        </div>

        <ul class="pagination justify-content-center" style="margin:20px 0">
            <!--Previous Page Button-->
            {% if page_number == 1 %}
                <li class="page-item disabled"><a class="page-link" href="">Previous</a></li>
            {% else %}
                <li class="page-item"><a class="page-link" href="{{ url_for('channels', page_number=page_number-1) }}">Previous</a></li>
            {% endif %}  

            <!--All Pages Buttons-->
            {% for i in range(1, num_pages+1) %}
                {% if i == page_number %}
                    <li class="page-item active"><a class="page-link" href="{{ url_for('channels', page_number=i) }}">{{i}}</a></li>
                {% else %}
                    <li class="page-item"><a class="page-link" href="{{ url_for('channels', page_number=i) }}">{{i}}</a></li>
                {% endif %}    
            {% endfor %}

            <!--Next Page Button-->
            {% if page_number == num_pages %}
                <li class="page-item disabled"><a class="page-link" href="">Next</a></li>
            {% else %}
                <li class="page-item"><a class="page-link" href="{{ url_for('channels', page_number=page_number+1) }}">Next</a></li>
            {% endif %}
        </ul>
    </div>
</div>

    <script>
        let items = document.getElementsByClassName("dropdown-item");
        var data = $('#channelArrayData').data().arr;
        var dataArr = processData(data);

        function buildDropDown() {
            let contents = [];
            for (const [name, info] of Object.entries(dataArr) ) {
                contents.push('<button class="dropdown-item"><b>' + name + '</b></button>');
                contents.push('<button class="dropdown-item"><b>' + name + '</b> - Description: ' + info.description + '</button>');
                contents.push('<button class="dropdown-item"><b>' + name + '</b> - Subscribers: ' + info.subscriber + '</button>');
                contents.push('<button class="dropdown-item"><b>' + name + '</b> - Total Views: ' + info.view + '</button>');
                contents.push('<button class="dropdown-item"><b>' + name + '</b> - Videos: ' + info.video + '</button>');
            }
            console.log(contents);
            $('#menuItems').append(contents.join(""));

            //Hide the row that shows no items were found
            $('#empty').hide()
        }
        buildDropDown();

        function filter(phrase) {
            var headers = {};
            var hidden = 0;

            for (const [name, info] of Object.entries(dataArr)) {
                if (name.toLowerCase().includes(phrase)) {
                    headers[name.toLowerCase()] = 1;
                } else if (("description: " + info.description.toLowerCase()).includes(phrase)) {
                    headers[name.toLowerCase() + " - description: " + info.description.toLowerCase()] = 1;
                } else if (("subscribers: " + info.subscriber.toLowerCase()).includes(phrase)) {
                    headers[name.toLowerCase() + " - subscribers: " + info.subscriber.toLowerCase()] = 1;
                } else if (("total views: " + info.view.toLowerCase()).includes(phrase)) {
                    headers[name.toLowerCase() + " - total views: " + info.view.toLowerCase()] = 1;
                } else if (("videos: " + info.video.toLowerCase()).includes(phrase)) {
                    headers[name.toLowerCase() + " - videos: " + info.video.toLowerCase()] = 1;
                }
            }

            for (i = 0; i < items.length; i++) {
                if (items[i].innerHTML.replace("<b>", "").replace("</b>", "").toLowerCase() in headers) {
                    $(items[i]).show();
                } else {
                    $(items[i]).hide()
                    hidden++
                }
            }

            //If no items match, show the empty view
            if (hidden === items.length) {
                $('#empty').show()
            }
            else {
                $('#empty').hide()
            }
        }

        $(document).ready(function() {
            $("#searchBar").on("keyup", function() {
                if ($(this).val().length > 0) {
                    $("#menu").show();
                    filter($(this).val().trim().toLowerCase());
                } else {
                    $("#menu").hide();
                }
            })
        });

        $('#menuItems').on('click', '.dropdown-item', function(){
            var tempStr = $(this)[0].innerHTML.split("</b>")[0].replace("<b>", "");
            console.log(typeof tempStr);
            var arrIdx = `dataArr[${tempStr}].idx`;
            console.log(arrIdx);
            document.write(`<script src="{{ url_for('channel_instance', arrayIndex=0) }}">\x3C/script>`);
        });

        function processData(str) {
            var strToArr = str.replace("[{", "").replace("}]", "").split("}, {");
            var finalObj = {};

            var tempStr = [];
            for (i = 0; i < strToArr.length; i++) {
                if (strToArr[i].includes("\", \'description\': \"")) tempStr = strToArr[i].split("\", \'description\': \"");
                else if (strToArr[i].includes("\', \'description\': \"")) tempStr = strToArr[i].split("\', \'description\': \"");
                else if (strToArr[i].includes("\", \'description\': \'")) tempStr = strToArr[i].split("\", \'description\': \'");
                else tempStr = strToArr[i].split("\', \'description\': \'");
                
                var nameStr = "";
                if (tempStr[0].includes("\'name\': \"", "")) nameStr = tempStr[0].replace("\'name\': \"", "");
                else nameStr = tempStr[0].replace("\'name\': \'", "");

                if (tempStr[1].includes("\', \'subscriber\': ")) tempStr = tempStr[1].split("\', \'subscriber\': ");
                else tempStr = tempStr[1].split("\", \'subscriber\': ");
                var descripStr = tempStr[0];

                tempStr = tempStr[1].split(", \'view\': ");
                var subscriberStr = tempStr[0];

                tempStr = tempStr[1].split(", \'video\': ");
                var viewStr = tempStr[0];
                var videoStr = tempStr[1];

                finalObj[nameStr] = {"description": descripStr, "subscriber": subscriberStr, "view": viewStr, "video": videoStr, "idx": i};
            }

            return finalObj;
        }
    </script>
{% endblock %}
