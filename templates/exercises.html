{% extends 'base.html' %}

{% block head %}
    <title>Exercises Model Page</title>
    <script type="text/javascript" src="/static/exercises.js"></script>
{% endblock %}

{% block body %}
<div class="exercise-div container-fluid">
    <div class="jumbotron-exercise jumbotron jumbotron-fluid text-center">
        <h1>Achieve your fitness goals</h1>
        <p class=modelDescription>Try out 100+ different exercises. </p>
    </div>
    <div id="sidebar-container">
        <div id="mySidenav" class="sidenav">
            <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
            <form id="exercisesFilterForm" action="{{ url_for('exercises', page_number=1) }}" method="post">
                <ul class="checkbox-menu">
                    <li class="dropdown-header">Category</li>
                    <li>
                        <label><input type="checkbox" id='exercisesOption1' name='checkedExerciseCategories' value="Abs">   Abs </label>
                    </li>
                    <li>
                        <label><input type="checkbox" id='exercisesOption2' name='checkedExerciseCategories' value="Arms"> Arms </label>
                    </li>
                    <li>
                        <label><input type="checkbox" id='exercisesOption3' name='checkedExerciseCategories' value="Back"> Back </label>
                    </li>
                    <li>
                        <label><input type="checkbox" id='exercisesOption4' name='checkedExerciseCategories' value="Calves"> Calves </label>
                    </li>
                    <li>
                        <label><input type="checkbox" id='exercisesOption5' name='checkedExerciseCategories' value="Chest"> Chest </label>
                    </li>
                    <li>
                        <label><input type="checkbox" id='exercisesOption6' name='checkedExerciseCategories' value="Legs"> Legs </label>
                    </li>
                    <li>
                        <label><input type="checkbox" id='exercisesOption7' name='checkedExerciseCategories' value="Shoulders"> Shoulders </label>
                    </li>
                    <li class="dropdown-header">Equipment</li>
                    <li>
                        <label><input type="checkbox"id='exercisesOption8' name='checkedEquipmentCategories' value="Barbell"> Barbell </label>
                    </li>
                    <li>
                        <label><input type="checkbox" id='exercisesOption9' name='checkedEquipmentCategories' value="Bench"> Bench </label>
                    </li>
                    <li>
                        <label><input type="checkbox" id='exercisesOption10' name='checkedEquipmentCategories' value="Dumbbell"> Dumbbell </label>
                    </li>
                    <li>
                        <label><input type="checkbox" id='exercisesOption11' name='checkedEquipmentCategories' value="Exercise mat"> Exercise Mat </label>
                    </li>
                    <li>
                        <label><input type="checkbox" id='exercisesOption12' name='checkedEquipmentCategories' value="EZ-Bar"> EZ-Bar </label>
                    </li>
                    <li>
                        <label><input type="checkbox" id='exercisesOption13' name='checkedEquipmentCategories' value="Kettlebell"> Kettlebell </label>
                    </li>
                    <li style="text-align: center; margin-top: 1rem; margin-bottom: 110px;">
                        <input type="hidden" id='exercisesResetHiddenField' name='resetHiddenField' value="">
                        <button class="reset-button btn btn-outline-light" type="button" name="Reset" onclick="resetCheckboxState('exercisesFilterForm', 'exercisesResetHiddenField')">Reset</button>
                        <button class="filter-button btn btn-outline-light" type="button" name="Filter" onclick="verifyCheckBoxes('exercisesFilterForm')">Filter</button>
                    </li>
                </ul>
            </form>
        </div>
    </div>
    <!-- Use any element to open the sidenav -->
    <div class="filtering-section">
        <button class="filter-open-button" onclick="openNav()">Filter ></button>
        <form id="exercisesSortForm" action="{{ url_for('exercises', page_number=1) }}" method="post">
            <label for="exercisesSortCriteriaMenu" id="exercisesSortMenuLabel">Sort by: </label>
            <select id="exercisesSortCriteriaMenu" name="exercisesSortCriteriaMenu">
                <option value="name">Name (default)</option>
                <option value="category">Category</option>
                <option value="equipment">Equipment</option>
            </select>
            <input type="hidden" id='exercisesSortingHiddenField' name='exercisesSortingHiddenField' value="">
            <img class="ascending-button" src="/static/ascendingSortIcon.png" alt="Ascending" onclick="submitSortForm('exercisesSortForm', 'exercisesSortingHiddenField', 'ascending');">
            <img class="descending-button" src="/static/descendingSortIcon.png" alt="Descending" onclick="submitSortForm('exercisesSortForm', 'exercisesSortingHiddenField', 'descending');">
        </form>
    </div>
    
    <div id="main">
        <!--Search Bar-->
        {% set dataArr = [] %}
        {% for obj in exercisesArray %}
            {% set dataArr = dataArr.append({"name": obj.name, "category": obj.category, "equipment": obj.equipment|join(', '), "description": obj.description}) %}
        {% endfor %}
        <meta id="exercisesArrayData" data-arr='{{dataArr}}'/>
        <div class="dropdown d-inline-block">
            <input class="input form-control ml-3 dropdown-toggle" id = "searchBar" type="search" placeholder="Search"/>
            <div id="menu" class="dropdown-menu" aria-labelledby="dropdown_coins" style="width: 85%">
                <div id="menuItems"></div>
                <div id="empty" class="dropdown-header">No items found</div>
                <div id="menuLinks"></div>
            </div>
        </div>
    </div>
    
    <!-- Add all page content inside this div if you want the side nav to push page content to the right (not used if you only want the sidenav to sit on top of the page -->
    <div id="main">
        <div class="grid-div container-fluid" id="modelGrid">
        {% set numFullRows = ((end + 1) - start) // 3 %}
        {% set numLeftOverChannels = ((end + 1) - start) % 3 %}
        {% for i in range(numFullRows) %}
            <div class="row justify-content-center" id="row{{ i|string }}">
            {% for offset in range(3) %}
                <div class="col-md-4 p-4">
                    <div class="card card-style h-100 pt-4" id="instanceCard_{{exercisesArray[start + 3*i + offset].arrayIndex}}">
                        <img class="card-img-top card-image-style img-fluid mx-auto" src="{{ exercisesArray[start + 3*i + offset].images[0] }}" onerror="this.onerror=null; this.src='{{ exercisesArray[start + 3*i+offset].images[1] }}'"; alt="{{ exercisesArray[start + 3*i + offset].name }}">
                        <div class="card-body">
                            <h2 class="card-title text-center" id="exerciseName_{{exercisesArray[start + 3*i + offset].arrayIndex}}">{{ exercisesArray[start + 3*i + offset].name }}</h2>
                            <p class="card-text">
                                <ul class="exerciseAttributesList list-unstyled">
                                    <li style="padding-bottom: 0.5em; padding-left: 1em; padding-top: 1em;" id="exerciseCategoryTxt_{{exercisesArray[start + 3*i + offset].arrayIndex}}"><b>Category: </b>{{ exercisesArray[start + 3*i + offset].category }}</li>
                                    <li style="padding-bottom: 0.5em; padding-left: 1em;" id="exerciseEquipText_{{exercisesArray[start + 3*i + offset].arrayIndex}}"><b>Equipment: </b>{{ exercisesArray[start + 3*i + offset].equipment|join(', ') }}</li>
                                    <li style="padding-left: 1em;" id="exerciseDescText_{{exercisesArray[start + 3*i + offset].arrayIndex}}"><b>Description: </b>{{ exercisesArray[start + 3*i + offset].description }}</li>
                                </ul>
                            </p>
                            <a href="{{ url_for('exercise_instance', arrayIndex=exercisesArray[start + 3*i + offset].arrayIndex) }}" class="stretched-link"></a>
                        </div>
                    </div>
                </div>
            {% endfor %}      
            </div>
        {% endfor %}

        {% if numLeftOverChannels > 0 %}
            <div class="row" id="bottomRow">
            {% for i in range(-numLeftOverChannels, 0) %}
                <div class="col-md-4 p-4">
                    <div class="card card-style h-100 pt-4">
                        <img class="card-img-top card-image-style img-fluid mx-auto" src="{{ exercisesArray[end + 1 + i].images[0] }}" onerror="this.onerror=null; this.src='{{ exercisesArray[end + 1 + i].images[1] }}'"; alt="{{ exercisesArray[end + 1 + i].name }}">
                        <div class="card-body">
                            <h2 class="card-title text-center">{{ exercisesArray[end + 1 + i].name }}</h2>
                            <p class="card-text">
                                <ul class="exerciseAttributesList list-unstyled">
                                    <li style="padding-bottom: 0.5em; padding-left: 1em; padding-top: 1em;"><b>Category: </b>{{ exercisesArray[end + 1 + i].category }}</li>
                                    <li style="padding-bottom: 0.5em; padding-left: 1em;"><b>Equipment: </b>{{ exercisesArray[end + 1 + i].equipment|join(', ') }}</li>
                                    <li style="padding-left: 1em;"><b>Description: </b>{{ exercisesArray[end + 1 + i].description }}</li>
                                </ul>
                            </p>
                            <a href="{{ url_for('exercise_instance', arrayIndex=exercisesArray[end + 1 + i].arrayIndex) }}" class="stretched-link"></a>
                        </div>
                    </div>
                </div>
            {% endfor %}
            </div>
        {% endif %}
        </div>

        <ul class="pagination justify-content-center" style="margin: 20px;">
            <!--Previous Page Button-->
            {% if page_number == 1 %}
                <li class="page-item disabled"><a class="page-link" href="">Previous</a></li>
            {% else %}
                <li class="page-item"><a class="page-link" href="{{ url_for('exercises', page_number=page_number-1) }}">Previous</a></li>
            {% endif %}  

            <!--All Pages Buttons-->
            {% for i in range(1, num_pages+1) %}
                {% if i == page_number %}
                    <li class="page-item active"><a class="page-link" href="{{ url_for('exercises', page_number=i) }}">{{i}}</a></li>
                {% else %}
                    <li class="page-item"><a class="page-link" href="{{ url_for('exercises', page_number=i) }}">{{i}}</a></li>
                {% endif %}    
            {% endfor %}

            <!--Next Page Button-->
            {% if page_number == num_pages %}
                <li class="page-item disabled"><a class="page-link" href="">Next</a></li>
            {% else %}
                <li class="page-item"><a class="page-link" href="{{ url_for('exercises', page_number=page_number+1) }}">Next</a></li>
            {% endif %}
        </ul>
    </div>
</div>
<script>
    let items = document.getElementsByClassName("dropdown-item");
    var data = $('#exercisesArrayData').data().arr;
    var dataArr = processData(data);

    function buildDropDown() {
        let contents = [];
        for (const [name, info] of Object.entries(dataArr) ) {
            contents.push('<button class="dropdown-item"><b>' + name + '</b></button>');
            contents.push('<button class="dropdown-item"><b>' + name + '</b> - Category: ' + info.category + '</button>');
            contents.push('<button class="dropdown-item"><b>' + name + '</b> - Equipment: ' + info.equipment + '</button>');
            contents.push('<button class="dropdown-item"><b>' + name + '</b> - Description: ' + info.description + '</button>');
        }
        $('#menuItems').append(contents.join(""));

        //Hide the row that shows no items were found
        $('#empty').hide()
    }
    buildDropDown();

    function filter(phrase) {
        var headers = {};
        var hidden = 0;

        for (const [name, info] of Object.entries(dataArr)) {
            if (name.toLowerCase().includes(phrase)) {
                headers[name.toLowerCase()] = 1;
            } else if (("category: " + info.category.toLowerCase()).includes(phrase)) {
                headers[name.toLowerCase() + " - category: " + info.category.toLowerCase()] = 1;
            } else if (("equipment: " + info.equipment.toLowerCase()).includes(phrase)) {
                headers[name.toLowerCase() + " - equipment: " + info.equipment.toLowerCase()] = 1;
            } else if (("description: " + info.description.toLowerCase()).includes(phrase)) {
                headers[name.toLowerCase() + " - description: " + info.description.toLowerCase()] = 1;
            }
        }

        for (i = 0; i < items.length; i++) {
            if (items[i].innerHTML.replace("<b>", "").replace("</b>", "").toLowerCase() in headers) {
                $(items[i]).show();
            } else {
                $(items[i]).hide()
                hidden++
            }
        }

        //If no items match, show the empty view
        if (hidden === items.length) {
            $('#empty').show()
        }
        else {
            $('#empty').hide()
        }
    }

    $(document).ready(function() {
        $("#searchBar").on("keyup", function() {
            if ($(this).val().length > 0) {
                $("#menu").show();
                filter($(this).val().trim().toLowerCase());
            } else {
                $("#menu").hide();
            }
        });
        $("#searchBar").on("search", function() {
            if($(this).val().length == 0) {
                $("#menu").hide();
            }
        });
    });

    $('#menuItems').on('click', '.dropdown-item', function(){
        var tempStr = $(this)[0].innerHTML.split("</b>")[0].replace("<b>", "");
        var arrIdx = dataArr[tempStr].idx;
        $("#searchBar").val("");

        window.location.href = "/exerciseinstance/" + arrIdx;
    });

    function processData(str) {
        var strToArr = str.replace("[{", "").replace("}]", "").split("}, {");
        var finalObj = {};

        var tempStr = [];
        for (i = 0; i < strToArr.length; i++) {
            tempStr = strToArr[i].split("\', \'category\': \'");
            
            var nameStr = "";
            nameStr = tempStr[0].replace("\'name\': \'", "");

            tempStr = tempStr[1].split("\', \'equipment\': \'");
            var categoryStr = tempStr[0];

            if (tempStr[1].includes("\', \'description\': \"")) {
                tempStr = tempStr[1].split("\', \'description\': \"");
            } else {
                tempStr = tempStr[1].split("\', \'description\': \'");
            }
            
            var equipmentStr = tempStr[0];
            var descriptionStr = tempStr[1];

            finalObj[nameStr] = {"category": categoryStr, "equipment": equipmentStr, "description": descriptionStr, "idx": i};
        }

        return finalObj;
    }
</script>
{% endblock %}